trigger:
   branches:
     include:
       - main
stages:
- stage: Validate
  displayName: "Validate Bicep Templates"
  jobs:
  - job: BicepValidation
    displayName: "Run Bicep Lint + What-if"
    pool:
      vmImage: 'ubuntu-latest'
    steps:
      - task: PowerShell@2
        displayName: 'Lint Bicep Template'
        inputs:
          targetType: 'inline'
          script: |
            Write-Host "üîç Linting Bicep..."
            bicep build ./main.bicep

      - task: PowerShell@2
        displayName: 'Bicep What-if Validation'
        inputs:
          targetType: 'inline'
          script: |
            Write-Host "üîé Validating Bicep Deployment..."
                az bicep version

                Write-Host "üì¶ Running What-If Analysis..."
                az deployment group what-if `
                  --resource-group rg-webapp-infra-dev `
                  --template-file ./main.bicep `
                  --parameters "main.parameters.json"
        
          
- stage: Deploy
  displayName: "Manual Approval Deploy"
  dependsOn: Validate
  condition: succeeded()
  jobs:
    - deployment: DeployInfra
      displayName: "Deploy to Azure (Manual Approval Required)"
      environment: 'Production'
      strategy: 
        runOnce:
          deploy:
            steps:
              - task: PowerShell@2
                inputs:
                  targetType: 'inline'
                  script: |
                    Write-Host "üöÄ Deploying Bicep Template..."
                    az deployment sub create `
                      --location westeurope `
                      --template-file ./main.bicep `
                      --parameters @main.parameters.json
                displayName: 'Deploy Bicep Template'